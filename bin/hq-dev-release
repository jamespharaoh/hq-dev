#!/usr/bin/env ruby

require "fileutils"

project = File.basename(Dir.pwd)
ver = ARGV[0]

def shell cmd
	success = system cmd
	exit 1 unless success
end

# TODO check the workspace is clean

puts ""
puts "running tests"
shell "bundle exec rake"

puts ""
puts "bumping version number"
shell "echo #{ver} > etc/hq-dev/version"
if File.exist? "data/gem-versions"
	File.open "data/gem-versions.new", "w" do
		|file_io|
		File.new("data/gem-versions").each do
			|line|
			line_name, line_ver = line.strip.split " "
			if line_name == "hq-dev"
				file_io.write "#{line_name} #{ver}\n"
			else
				file_io.write "#{line_name} #{line_ver}\n"
			end
		end
	end
	FileUtils.mv "data/gem-versions.new", "data/gem-versions"
end

puts ""
puts "running bundle update"
shell "bundle update"

puts ""
puts "committing changes"
shell "git add -A"
shell "git diff --cached"
sleep 2
shell "git commit -m 'bump version number to #{ver}'"

puts ""
puts "pushing to github"
shell "git tag #{ver}"
shell "git push origin master #{ver}"

puts ""
puts "pushing to rubygems"
shell "gem build #{project}.gemspec"
shell "gem push #{project}-#{ver}.gem"

if project == "hq-dev"
	puts ""
	puts "installing gem"
	shell "gem install hq-dev -v #{ver}"
end

puts ""
puts "done!"
puts ""
